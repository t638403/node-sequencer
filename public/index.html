<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Node Sequencer</title>

    <script src="js/socket.io.js"></script>
    <script src="bower/jquery/dist/jquery.min.js"></script>
    <script src="bower/lodash/dist/lodash.min.js"></script>
    <script src="js/NodeSequencer.js"></script>
    <script src="js/Instrument.js"></script>
    <script src="js/Sequence.js"></script>
    <script>
        var socket = io.connect('http://localhost');
        socket.on('news', function (data) {
            console.log(data);
            socket.emit('my other event', { my: 'data' });
        });

        var xl1 = new Instrument({
            name:'XL-1',
            channel:1
        });

        var s1 = new Sequence([
            '1:1/8:1/8:C#2:80',
            '1:3/8:1/8:D2:80',
            '1:5/8:1/8:E2:80',
            '1:7/8:1/8:F2:80',
            '3:1/8:1/8:C#2:80',
            '3:3/8:1/8:D2:80',
            '3:5/8:1/8:E2:80',
            '3:7/8:1/8:F2:80'
        ]);

        var nodeSequencer = new NodeSequencer({
            midi:{
                'in':{
                    port:1
                },
                'out':{
                    port:2
                }
            },
            global:{
                bpm:120
            },
            instruments:[xl1],
            sequences:{
                'XL-1':[s1]
            }
        });

    </script>
</head>

<body>
<form>
    MIDI in:
    <select class='setting' id="midi-in-port"></select>
    out:
    <select class='setting' id="midi-out-port"></select><br/>

    bpm:
    <input type="text" class="setting" id="global-bpm"/>
    <input type="button" value="Rew" id="rewind"/>
    <input type="button" value="Play" id="play"/>
    <input type="button" value="Stop" id="stop"/>
    <br/>

</form>
<script type="text/javascript">


    $('input.setting').each(function(i) {
        var input = $(this);
        input.val(nodeSequencer.setting(input.attr('id')))
    });

    $.when(
            $.getJSON('/midi/in/portnames'),
            $.getJSON('/midi/out/portnames')
    ).done(function(portnames_in, portnames_out) {
        _.each(portnames_in[0], function(portname, portNumber) {
            $('select.setting#midi-in-port').append($('<option value="'+portNumber+'">'+portname+'</option>'))
        });
        _.each(portnames_out[0], function(portname, portNumber) {
            $('select.setting#midi-out-port').append($('<option value="'+portNumber+'">'+portname+'</option>'))
        });

        $('select.setting').each(function(i) {
            var $select = $(this);
            var value = nodeSequencer.setting($select.attr('id'));
            $select.find('option[value="'+value+'"]').prop('selected', true)
        });

    })

    // EVENTS
    $('select.setting').change(function(e) {
        var $select = $(this);
        var value = nodeSequencer.setting($select.attr('id'), $select.find('option:selected').val());
        console.log('Setting %s: %s', $select.attr('id'), value);
    });

    $('input.setting').focusout(function(e) {
        var $input = $(this);
        var value = nodeSequencer.setting($input.attr('id'), $input.val());
        console.log('Setting %s: %s', $input.attr('id'), value);
    });

    $('input#play').click(function(){
        nodeSequencer.play();
    })

    $('input#stop').click(function(){
        nodeSequencer.stop();
    })

    $('input#rewind').click(function(){
        nodeSequencer.rewind();
    })

    $(window).on('beat', function(e, beat){

    })

</script>
</body>

</html> 